---
title: "E0 Data analysis pipeline"
output: html_notebook
---
```{r setup, include=FALSE}
# Clear the environment
rm(list = ls())
gc()
# Load required packages to set wd
if (!require("rstudioapi")) install.packages("rstudioapi")
library(rstudioapi)
library(knitr)

# Get the directory of the active document and then move to the parent directory
parent_dir <- dirname(dirname(rstudioapi::getActiveDocumentContext()$path))

# Set the root directory for all chunks to the parent directory
opts_knit$set(root.dir = parent_dir)
```

```{r}
# Verify the working directory in subsequent chunks
getwd()
```


```{r}
# Function to print time difference
print_time_diff <- function(start_time) {
  print(difftime(Sys.time(), start_time, units = "sec"))
}
```

```{r}
source("./Functions/A0 Package Setup.R")
gc()
```


```{r}
#setting up the Job type
job <- "stat"
write_rds(job, file = "data/intermediate/crs04_job_utf8_full.rds")
```



```{r}
#create a dataframe for languages and save it

df_lang <- data.frame(
  lang = c("en", "fr", "es", "de"), 
  language = c("english", "french", "spanish", "german"), 
  stringsAsFactors = FALSE
)
write_rds(df_lang, file = "data/intermediate/crs04_df_lang_utf8_full.rds")
```

```{r}
#process each language by iterationg over the rows of df_lang, saving the relevant information, and running the analysis scripts
df_lang <- read_rds("data/intermediate/crs04_df_lang_utf8_full.rds")


#use seq_alone here to avoid error when iterate
walk(seq_along(df_lang), function(i) {
  # Save sequence number
  write_rds(i, file = "data/Intermediate/crs04_i_utf8_full.rds")
  
  # Save language 
  lang <- df_lang$lang[i]
  language <- df_lang$language[i]
  print(lang)
  save(lang, language, file = "data/intermediate/crs04_lang_utf8_full.rdata")
  
  # Running the analysis
  source("./functions/04.0 separate data frame into two.R")
  print(0)
  source("./functions/04.1 preprocess and create dict.R")
  print(1)
  source("./functions/04.2 create dict.R")
  print(2)
  source("./functions/04.3 dtm crs 0.R")
  print(3)
  source("./functions/04.4 identify projects.R")
  print(4)
  
  # Extracting the sequence number
  i <- read_rds("data/Intermediate/crs04_i_utf8_full.rds")
  print(i)
})

beep(3)
```


```{r}
#perform final processing steps based on the job type and aggregate the results
df_lang <- read_rds("data/intermediate/crs04_df_lang_utf8_full.rds")
job <- read_rds("data/Intermediate/crs04_job_utf8_full.rds")
job_specific_suffix <- ifelse(job == "gen", "_gen_full_", "_full_")

list_path_ids <- paste0(
  "./Data/intermediate/crs04.4_positive_id_", 
  c(df_lang$lang, "en"), 
  job_specific_suffix, 
  year(Sys.Date()), 
  ".rds"
) %>% unique()

list_id <- list_path_ids %>%
  map(read_rds) %>%
  reduce(c) %>%
  unique()

crs_path_new <- paste0(
  "./Data/intermediate/crs04_positive_id", 
  job_specific_suffix, 
  year(Sys.Date()), 
  ".rds"
)

write_rds(list_id, file = crs_path_new)
```

